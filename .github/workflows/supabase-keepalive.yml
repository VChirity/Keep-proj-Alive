# Mantém os projetos Supabase ativos (evita pausa por inatividade no plano gratuito).
# Roda todo dia e faz uma requisição leve em cada projeto listado em supabase-keepalive-projects.json
name: Supabase keep-alive

on:
  schedule:
    # Todo dia às 12:00 UTC (09:00 BRT)
    - cron: "0 12 * * *"
  workflow_dispatch: # Rodar manualmente: Actions > Supabase keep-alive > Run workflow

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ping Supabase (todos os projetos)
        run: |
          CONFIG=".github/supabase-keepalive-projects.json"
          if [ ! -f "$CONFIG" ]; then echo "Arquivo $CONFIG não encontrado."; exit 1; fi
          COUNT=$(jq length "$CONFIG")
          echo "Encontrados $COUNT projeto(s). Pingando..."
          for i in $(seq 0 $((COUNT - 1))); do
            NAME=$(jq -r ".[$i].name" "$CONFIG")
            URL=$(jq -r ".[$i].url" "$CONFIG")
            KEY=$(jq -r ".[$i].anonKey" "$CONFIG")
            if [ "$URL" = "null" ] || [ -z "$URL" ] || [[ "$URL" == COLE_* ]]; then
              echo "[$NAME] Ignorado (URL não configurado)."
              continue
            fi
            OK=0
            # 1) Auth health (não precisa de chave)
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 -H "Accept: application/json" "$URL/auth/v1/health" 2>/dev/null || echo "000")
            if [ "$CODE" = "200" ]; then
              echo "[$NAME] OK (auth health)."
              OK=1
            fi
            # 2) REST com chave (GET na API)
            if [ "$OK" -eq 0 ] && [ "$KEY" != "null" ] && [ -n "$KEY" ] && [[ "$KEY" != COLE_* ]]; then
              CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 \
                -H "apikey: $KEY" -H "Authorization: Bearer $KEY" \
                -H "Accept: application/json" -H "Content-Type: application/json" \
                "$URL/rest/v1/" 2>/dev/null || echo "000")
              if [ "$CODE" != "000" ] && [ "$CODE" -lt 400 ] 2>/dev/null; then
                echo "[$NAME] OK (REST)."
                OK=1
              fi
              # 2b) Alguns projetos respondem 200 em OPTIONS
              if [ "$OK" -eq 0 ]; then
                CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 -X OPTIONS \
                  -H "apikey: $KEY" -H "Authorization: Bearer $KEY" \
                  "$URL/rest/v1/" 2>/dev/null || echo "000")
                if [ "$CODE" = "200" ] || [ "$CODE" = "204" ]; then
                  echo "[$NAME] OK (REST OPTIONS)."
                  OK=1
                fi
              fi
            fi
            # 3) Raiz (fallback - qualquer resposta conta como uso)
            if [ "$OK" -eq 0 ]; then
              CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "$URL/" 2>/dev/null || echo "000")
              echo "[$NAME] Ping feito (HTTP $CODE)."
            fi
          done
          echo "Concluído. Ambos os projetos foram acessados."
